package contracts

import (
	"bytes"
	"encoding/json"
	"io/ioutil"
	"os"
	"testing"
	"time"

	"github.com/stretchr/testify/suite"
)

const (
	_imageName             = "tomer.azurecr.io/core/app:4.6"
	_imageDigest           = "sha256:4a1c4b21597c1b4415bdbecb28a3296c6b5e23ca4f9feeb599860a1dac6a0108"
	_generatedTimestampStr = "2021-01-01T22:00:00+00:00"
	_containerName         = "testContainer"
	_scanStatus            = UnhealthyScan
	_testDataJsonFilePath  = "./testdata/containers_vulnerability_scan_info.json"
)

type TestSuite struct {
	suite.Suite
	info *ContainerVulnerabilityScanInfoList
}

func (suite *TestSuite) SetupSuite() {
	generatedTimestamp, err := time.Parse(time.RFC3339, _generatedTimestampStr)
	if err != nil {
		suite.Fail("received error %t", err)
	}
	suite.info = &ContainerVulnerabilityScanInfoList{
		GeneratedTimestamp: generatedTimestamp,
		Containers: []*ContainerVulnerabilityScanInfo{
			{
				Name: _containerName,
				Image: &Image{
					Name:   _imageName,
					Digest: _imageDigest,
				},
				ScanStatus: _scanStatus,
				ScanFindings: []*ScanFinding{
					{
						Patchable: true,
						Id:        "123",
						Severity:  "High",
					},
				},
			},
		},
	}
}

func (suite *TestSuite) Test_AssertInfoMarshalString() {

	// Marshal the info object
	ser, err := json.Marshal(suite.info)
	if err != nil {
		suite.Fail("received error %t", err)
	}

	// Convert byte slice to a string
	actualMarshaledObjectStr := string(ser)

	// Read expected json
	jsonFile, err := os.Open(_testDataJsonFilePath)
	if err != nil {
		suite.Fail("received error %t", err)
	}

	expectedByteValue, err := ioutil.ReadAll(jsonFile)
	if err != nil {
		suite.Fail("received error %t", err)
	}

	err = jsonFile.Close()
	if err != nil {
		suite.Fail("received error %t", err)
	}

	// Clean new lines and spaces in string
	expectedBuffer := new(bytes.Buffer)
	err = json.Compact(expectedBuffer, expectedByteValue)
	if err != nil {
		suite.Fail("received error %t", err)
	}
	expectedMarshaledObjectStr := expectedBuffer.String()

	// Compare
	suite.Equal(expectedMarshaledObjectStr, actualMarshaledObjectStr)
}

func (suite *TestSuite) Test_ScanStausEnumsValues() {
	suite.Equal(string(UnhealthyScan), "unhealthyScan")
	suite.Equal(string(HealthyScan), "healthyScan")
	suite.Equal(string(Unscanned), "unscanned")
}

func Test_ContainerScanVulnerabilities(t *testing.T) {
	suite.Run(t, new(TestSuite))
}
