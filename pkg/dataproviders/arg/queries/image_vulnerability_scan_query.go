package queries

// _containerVulnerabilityScanResultsQueryTemplateStr is template string for ContainerVulnerabilityScanResultsQuery
const _containerVulnerabilityScanResultsQueryTemplateStr = `
securityresources
 | where type == 'microsoft.security/assessments/subassessments'
 // The 2 lines below describe why we used in the third line thw two numbers 130 and 78.
 // 130 = strlen("providers/Microsoft.Security/assessments/dbd0cb49-b563-45e7-9724-889e799fa648/subassessments/b894c178-8c91-448d-9a77-9de8bb4508dc");
 // 78  = strlen("providers/Microsoft.Security/assessments/dbd0cb49-b563-45e7-9724-889e799fa648");
 | where indexof(id,'/providers/Microsoft.Security/assessments/dbd0cb49-b563-45e7-9724-889e799fa648', -130, 78) != -1 
 | extend digest = tostring(properties.additionalData.imageDigest)
 | extend repository = tostring(properties.additionalData.repositoryName)
 | extend registry = tostring(properties.additionalData.registryHost)
 | where   registry =~ "{{.Registry}}" and repository =~ "{{.Repository}}" and digest == "{{.Digest}}"
 | parse id with  registryResourceId '/providers/Microsoft.Security/assessments/' *
 | extend scanFindingSeverity = tostring(properties.status.severity), scanStatus = tostring(properties.status.code)
 | extend id = tostring(properties.id), patchable = tostring(properties.additionalData.patchable)
 | project registry, repository, digest, scanStatus, scanFindingSeverity, id, patchable
`

// ContainerVulnerabilityScanResultsQueryParameters Parameters for _containerVulnerabilityScanResultsQueryTemplateStr query template
type ContainerVulnerabilityScanResultsQueryParameters struct {
	// Registry Image registry
	Registry string
	// Repository image repository
	Repository string
	// Digest image digest
	Digest string
}

// ContainerVulnerabilityScanResultsQueryResponseObject object returns in each row query above
type ContainerVulnerabilityScanResultsQueryResponseObject struct {
	// Registry Image registry
	Registry string `json:"registry"`
	// Repository image repository
	Repository string `json:"repository"`
	// Digest image digest
	Digest string `json:"digest"`
	// ScanStatus Scan status for image
	ScanStatus string `json:"scanStatus"`
	// ScanFindingSeverity Finding Severity
	ScanFindingSeverity string `json:"scanFindingSeverity"`
	// Id Finding Id
	Id string `json:"id"`
	// Patchable Is finding patchable
	Patchable bool `json:"patchable,string"`
}
